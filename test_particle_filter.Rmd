---
title: "test_particle_filter"
author: "Alessio Zakaria"
date: "21 May 2020"
output: pdf_document
---

```{r}
library(RcppArmadillo)
library(Rcpp)
library(pomp)
```

Generate data
```{r}
n <- 763

#y <- sample.int(100, n, replace = TRUE)
#df <- data.frame(B=y, tim = seq(n))

nparticles <-  10
initial_state <- c(n-1, 1, 0)
params <- c(n, 1, 1, 1, 1)
```

```{r}
sourceCpp("/home/alessio/Documents/uni/phd/sc2/particle-filter/particle.cpp")
sourceCpp("/home/alessio/Documents/uni/phd/sc2/particle-filter/particlepar.cpp")
```
  
```{r}
q <- vector()
p <- vector()
for(i in 1:100){
  q[[i]] <- particleFilterCpp(bsflu$B, params, nparticles, initial_state)
  p[[i]] <- particleFilterCppPar(bsflu$B, params, nparticles, initial_state)
}
par(mfrow=c(2,1))
plot(density(q))
plot(density(p))
```

```{r}
particleFilterCppPar(bsflu$B, params, nparticles, initial_state)
```




```{r}
pfCpp <- function(n, nparticles) {
   v <- vector() 
   for(i in 1:n) {
     v[[i]] <- particleFilterCpp(pomp::bsflu$B, params, nparticles, initial_state)
   }
   return(v)
}
```

```{r}
pfCppPar <- function(n, nparticles) {
  v <- vector()
  for(i in 1:n) {
    v[[i]] <- particleFilterCppPar(pomp::bsflu$B, params, nparticles, initial_state)
  }
  return(v)
}
```




```{r}
library(microbenchmark)
microbenchmark(pfCppPar(10, 10), pfCpp(10, 10))

```
  
  
```{r}
evalCpp(k)
```
